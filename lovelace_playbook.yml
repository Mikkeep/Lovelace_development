- name: Start Server and install packages
  hosts: Lovelace
  vars:
    ansible_python_interpreter: /usr/bin/python3
  become: yes
  become_user: root
  tasks:
  
    - name: Enable EPEL
      get_url:
        url: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
    
    - name: Install EPEL
      yum:
        name:
          - epel-release-latest-7.noarch.rpm
          
    - name: Enable IUS
      get_url:
        url: https://rhel7.iuscommunity.org/ius-release.rpm
    
    - name: Install IUS
      yum:
        name:
          - ius-release.rpm
          
    - name: Enable PostGreSQL_1
      get_url:
        url: http://yum.postgresql.org/9.5/redhat/rhel-7-x86_64/pgdg-redhat95-9.5-2.noarch.rpm
    
    - name: Install PostGreSQL_1
      yum:
        name:
          - pgdg-redhat95-9.5-2.noarch.rpm

    - name: Install PostGreSQL_2
      yum:
        name:
          - postgresql95-server postgresql95-contrib

    - name: Initdb PostGreSQL
      ansible.builtin.shell:
        cmd: /usr/pgsql-9.5/bin/postgresql95-setup initdb
    
    - name: Edit PostGreSQL conf
      ansible.builtin.lineinfile:
        path: /var/lib/pgsql/9.5/data/postgresql.conf
        regexp: '^listen_addresses = '
        line: listen_addresses = 'localhost,192.168.1.14'

    - name: Edit PostGreSQL pg_hba conf
      ansible.builtin.lineinfile:
        path: /var/lib/pgsql/9.5/data/pg_hba.conf
        regexp: '^host '
        line: host    lovelace    lovelace    192.168.1.14/24 md5
  
    - name: Start and enable postgres on startup
      service: "name={{ item }} state=started enabled=yes"
      with_items:
        - postgresql-9.5

    - name: Create webserver db
      postgresql_db:
        state: present
        name: lovelace
      become: yes
      become_user: postgres

    - name: Create db user
      postgresql_user:
        state: present
        name: lovelace
        password: lovelace
      become: yes
      become_user: postgres

    - name: Grant db user access to webserver db
      postgresql_privs:
        type: database
        database: lovelace
        roles: postgres
        grant_option: no
        privs: all
      become: yes
      become_user: postgres

